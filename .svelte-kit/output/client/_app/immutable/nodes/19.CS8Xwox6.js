import"../chunks/DsnmJJEf.js";import"../chunks/COTvsYcR.js";import{o as Q}from"../chunks/DQtEjgo4.js";import{p as X,f as x,g as a,c as b,d as Y,s as v,j as r,m as g,e as p,r as d,t as k,b as Z}from"../chunks/BjJWVY7i.js";import{s as S}from"../chunks/DyiMSgY8.js";import{i as N}from"../chunks/D6O3RN6I.js";import{r as q}from"../chunks/DWyjkCdo.js";import{e as C}from"../chunks/CbnbkC1n.js";import{b as I}from"../chunks/Btu2CQ7A.js";import{i as $}from"../chunks/BbceK8gy.js";import{g as w}from"../chunks/Bz7ZLckS.js";var ee=x('<div class="error svelte-1x05zx6"> </div>'),te=x('<div class="message svelte-1x05zx6"> </div>'),re=x('<label class="svelte-1x05zx6">OTP <input name="otp" autocomplete="one-time-code"/></label> <button class="login-btn svelte-1x05zx6"> </button>',1),ne=x('<button class="login-btn svelte-1x05zx6"> </button>'),oe=x('<section class="login-section svelte-1x05zx6"><div class="login-form svelte-1x05zx6"><h2>Login</h2> <!> <!> <label class="svelte-1x05zx6">Username <input name="username" autocomplete="username"/></label> <!></div></section>');function ge(R,V){X(V,!1);let y=g(""),O=g(""),i=g(null),m=g(null),P=g(!1),u=g(!1);async function A(){if(r(i,null),r(m,null),!a(y).trim()){r(i,"Please enter a username");return}r(u,!0);try{let l=function(c){try{if(c&&c.type&&typeof c.data=="string"){const f=JSON.parse(c.data);if(Array.isArray(f)&&f.length>0&&typeof f[0]=="object"){const h=f[0],_={};for(const U of Object.keys(h)){const H=h[U];_[U]=f[H]}return _}return f}}catch{}return c};const e=new FormData;e.append("username",a(y).trim());const o=new URL("/login",location.origin).toString(),n=await fetch(o,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(n.redirected){w(n.url);return}const s=await n.text().catch(()=>null);let t=null;if(s)try{t=JSON.parse(s)}catch{console.warn("sendOtp: response not JSON, using text fallback")}if(!n.ok){console.error("sendOtp: non-ok response",n.status,s),r(i,t?.error||s||"Failed to send OTP");return}t&&typeof t=="object"&&t.type&&(t=l(t)),t?.otpSent?(r(P,!0),r(m,t.message||"OTP sent to your email"),requestAnimationFrame(()=>document.querySelector('input[name="otp"]')?.focus())):s&&!t&&r(m,s)}catch(e){console.error("sendOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(i,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(i,e?.message||"Network error")}finally{r(u,!1)}}async function J(){if(r(i,null),r(m,null),!a(O).trim()){r(i,"Please enter the OTP");return}r(u,!0);try{const e=new FormData;e.append("username",a(y).trim()),e.append("otp",a(O).trim());const o=new URL("/login",location.origin).toString(),n=await fetch(o,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(n.redirected){w(n.url);return}const s=await n.text().catch(()=>null);let t=null;if(s)try{t=JSON.parse(s)}catch{console.warn("verifyOtp: response not JSON, using text fallback")}if(t&&typeof t=="object"&&t.type)try{const l=JSON.parse(t.data);if(Array.isArray(l)&&l.length>0&&typeof l[0]=="object"){const c=l[0],f={};for(const h of Object.keys(c)){const _=c[h];f[h]=l[_]}t=f}else t=l}catch{}if(!n.ok){console.error("verifyOtp: non-ok response",n.status,s),r(i,t?.error||s||"OTP verification failed");return}if(t?.success){if(t.redirect){w(t.redirect);return}w("/");return}s&&!t&&r(m,s)}catch(e){console.error("verifyOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(i,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(i,e?.message||"Network error")}finally{r(u,!1)}}function j(e){e.key==="Enter"&&(e.preventDefault(),a(P)?J():A())}Q(()=>(document.addEventListener("keydown",j),()=>document.removeEventListener("keydown",j))),$();var T=oe(),E=p(T),L=v(p(E),2);{var K=e=>{var o=ee(),n=p(o,!0);d(o),k(()=>S(n,a(i))),b(e,o)};N(L,e=>{a(i)&&e(K)})}var F=v(L,2);{var M=e=>{var o=te(),n=p(o,!0);d(o),k(()=>S(n,a(m))),b(e,o)};N(F,e=>{a(m)&&e(M)})}var z=v(F,2),D=v(p(z));q(D),d(z);var W=v(z,2);{var B=e=>{var o=re(),n=Z(o),s=v(p(n));q(s),d(n);var t=v(n,2),l=p(t,!0);d(t),k(()=>{t.disabled=a(u),S(l,a(u)?"Verifying...":"Verify OTP")}),I(s,()=>a(O),c=>r(O,c)),C("click",t,J),b(e,o)},G=e=>{var o=ne(),n=p(o,!0);d(o),k(()=>{o.disabled=a(u),S(n,a(u)?"Sending...":"Send OTP")}),C("click",o,A),b(e,o)};N(W,e=>{a(P)?e(B):e(G,!1)})}d(E),d(T),I(D,()=>a(y),e=>r(y,e)),b(R,T),Y()}export{ge as component};
