import"../chunks/DsnmJJEf.js";import"../chunks/DsPuBiMm.js";import{o as me}from"../chunks/BaSLTKbU.js";import{p as ue,f as A,b as P,c as pe,d as m,e as g,i as I,g as n,m as O,r as u,n as ne,s as r,t as J,aS as ve}from"../chunks/N5lxWZGS.js";import{s as U}from"../chunks/B135_YsI.js";import{i as M}from"../chunks/DrWauV8B.js";import{c as ge}from"../chunks/DCKGlpqt.js";import{r as $}from"../chunks/BnZ110ug.js";import{e as q}from"../chunks/Dx3h8YKD.js";import{b as z,a as ye}from"../chunks/DnwoYYiD.js";import{i as be}from"../chunks/Bc0xGMnQ.js";import{g as T}from"../chunks/WNbVgFxQ.js";import{C as he}from"../chunks/Bv3Pzr92.js";var we=A('<div class="error"> </div>'),_e=A('<div class="message"> </div>'),ke=A('<label>Password <input name="password" type="password" autocomplete="current-password"/></label> <button class="login-btn"> </button>',1),Oe=A('<label>OTP <input name="otp" autocomplete="one-time-code"/></label> <button class="login-btn"> </button>',1),Se=A('<button class="login-btn"> </button>'),xe=A('<div class="brand"><div class="logo">RAMS</div> <div class="title">Residence Access Management System</div></div> <div class="login-form"><h2>Login</h2> <!> <!> <label>Username <input name="username" autocomplete="username"/></label> <div class="login-helpers"><label class="remember-label" for="remember"><input id="remember" type="checkbox" aria-label="Remember me"/> <span class="remember-text">Remember me</span></label> <a href="/login/forgot" class="forgot-link">Forgot password?</a></div> <!></div>',1),Pe=A('<section class="login-viewport"><div class="login-container"><!></div></section>');function Ie(ae,oe){ue(oe,!1);let h=O(""),F=O(""),C=O(""),i=O(null),w=O(null),V=O(!1),p=O(!1),E=O(!1),L=O(null);async function B(){if(r(i,null),r(w,null),!n(h).trim()){r(i,"Please enter a username");return}if(await Y(),n(L)==="guard"){r(i,"This account is a guard. Please login with password.");return}r(p,!0);try{let c=function(o){try{if(o&&o.type&&typeof o.data=="string"){const d=JSON.parse(o.data);if(Array.isArray(d)&&d.length>0&&typeof d[0]=="object"){const v=d[0],_={};for(const S of Object.keys(v)){const j=v[S];_[S]=d[j]}return _}return d}}catch{}return o};const e=new FormData;e.append("username",n(h).trim()),e.append("remember",n(E)?"1":"0");const y=new URL("/login",location.origin).toString(),a=await fetch(y,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){T(a.url);return}const s=await a.text().catch(()=>null);let t=null;if(s)try{t=JSON.parse(s)}catch{console.warn("sendOtp: response not JSON, using text fallback")}if(!a.ok){console.error("sendOtp: non-ok response",a.status,s),r(i,t?.error||s||"Failed to send OTP");return}t&&typeof t=="object"&&t.type&&(t=c(t)),t?.otpSent?(r(V,!0),r(w,t.message||"OTP sent to your email"),requestAnimationFrame(()=>document.querySelector('input[name="otp"]')?.focus())):s&&!t&&r(w,s)}catch(e){console.error("sendOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(i,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(i,e?.message||"Network error")}finally{r(p,!1)}}async function H(){if(r(i,null),r(w,null),!n(h).trim()){r(i,"Please enter a username");return}if(!n(C).trim()){r(i,"Please enter your password");return}r(p,!0);try{const e=new FormData;e.append("username",n(h).trim()),e.append("password",n(C).trim()),e.append("remember",n(E)?"1":"0");const y=new URL("/login",location.origin).toString(),a=await fetch(y,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){T(a.url);return}const s=await a.text().catch(()=>null);let t=null;if(s)try{t=JSON.parse(s)}catch{}if(t&&typeof t=="object"&&t.type)try{const c=JSON.parse(t.data);if(Array.isArray(c)&&c.length>0&&typeof c[0]=="object"){const o=c[0],d={};for(const v of Object.keys(o)){const _=o[v];d[v]=c[_]}t=d}else t=c}catch{}if(!a.ok){r(i,t?.error||s||"Login failed");return}if(t?.success){if(t.redirect){T(t.redirect);return}T("/");return}s&&!t&&r(w,s)}catch(e){console.error("submitGuardPassword: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(i,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(i,e?.message||"Network error")}finally{r(p,!1)}}async function Q(){if(r(i,null),r(w,null),!n(F).trim()){r(i,"Please enter the OTP");return}r(p,!0);try{const e=new FormData;e.append("username",n(h).trim()),e.append("otp",n(F).trim()),e.append("remember",n(E)?"1":"0");const y=new URL("/login",location.origin).toString(),a=await fetch(y,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){T(a.url);return}const s=await a.text().catch(()=>null);let t=null;if(s)try{t=JSON.parse(s)}catch{console.warn("verifyOtp: response not JSON, using text fallback")}if(t&&typeof t=="object"&&t.type)try{const o=JSON.parse(t.data);if(Array.isArray(o)&&o.length>0&&typeof o[0]=="object"){const d=o[0],v={};for(const _ of Object.keys(d)){const S=d[_];v[_]=o[S]}t=v}else t=o}catch{}if(!a.ok){console.error("verifyOtp: non-ok response",a.status,s),r(i,t?.error||s||"OTP verification failed");return}const c=t?.redirect||Array.isArray(t)&&t[2]||null;if(c){T(c);return}if(t?.success){T("/");return}s&&!t&&r(w,s)}catch(e){console.error("verifyOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(i,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(i,e?.message||"Network error")}finally{r(p,!1)}}function X(e){e.key==="Enter"&&(e.preventDefault(),n(L)==="guard"?H():n(V)?Q():B())}me(()=>{document.addEventListener("keydown",X);const e=document.documentElement.style.overflow||document.body.style.overflow;return document.documentElement.style.overflow="hidden",document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",X),document.documentElement.style.overflow=e,document.body.style.overflow=e}});async function Y(){if(r(L,null),!!n(h).trim())try{const e=new URL("/login/identify",location.origin);e.searchParams.set("username",n(h).trim());const y=await fetch(e.toString(),{method:"GET",credentials:"same-origin"});if(!y.ok)return;const a=await y.json().catch(()=>null);a&&a.role&&r(L,a.role)}catch(e){console.warn("identifyUser failed",e)}}be();var K=Pe(),Z=m(K),se=m(Z);ge(se,()=>he,(e,y)=>{y(e,{className:"login-section",padding:"2.25rem",children:(a,s)=>{var t=xe(),c=g(I(t),2),o=g(m(c),2);{var d=l=>{var f=we(),k=m(f,!0);u(f),J(()=>U(k,n(i))),P(l,f)};M(o,l=>{n(i)&&l(d)})}var v=g(o,2);{var _=l=>{var f=_e(),k=m(f,!0);u(f),J(()=>U(k,n(w))),P(l,f)};M(v,l=>{n(w)&&l(_)})}var S=g(v,2),j=g(m(S));$(j),u(S);var W=g(S,2),ee=m(W),te=m(ee);$(te),ne(2),u(ee),ne(2),u(W);var ie=g(W,2);{var le=l=>{var f=ke(),k=I(f),D=g(m(k));$(D),u(k);var N=g(k,2),x=m(N,!0);u(N),J(()=>{N.disabled=n(p),U(x,n(p)?"Logging in...":"Login")}),z(D,()=>n(C),b=>r(C,b)),q("click",N,H),P(l,f)},ce=l=>{var f=ve(),k=I(f);{var D=x=>{var b=Oe(),R=I(b),re=g(m(R));$(re),u(R);var G=g(R,2),de=m(G,!0);u(G),J(()=>{G.disabled=n(p),U(de,n(p)?"Verifying...":"Verify OTP")}),z(re,()=>n(F),fe=>r(F,fe)),q("click",G,Q),P(x,b)},N=x=>{var b=Se(),R=m(b,!0);u(b),J(()=>{b.disabled=n(p),U(R,n(p)?"Sending...":"Send OTP")}),q("click",b,B),P(x,b)};M(k,x=>{n(V)?x(D):x(N,!1)})}P(l,f)};M(ie,l=>{n(L)==="guard"?l(le):l(ce,!1)})}u(c),z(j,()=>n(h),l=>r(h,l)),q("blur",j,()=>Y()),ye(te,()=>n(E),l=>r(E,l)),P(a,t)},$$slots:{default:!0}})}),u(Z),u(K),P(ae,K),pe()}export{Ie as component};
