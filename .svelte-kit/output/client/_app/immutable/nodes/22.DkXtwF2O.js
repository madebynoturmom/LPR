import"../chunks/DsnmJJEf.js";import"../chunks/Dr5p_gXH.js";import{o as re}from"../chunks/G6y-YXti.js";import{p as ae,f as O,g as s,c as b,d as ne,s as g,e as p,j as r,m as h,r as m,t as S,b as U,aQ as se}from"../chunks/D6_VZFDO.js";import{s as P}from"../chunks/BDSG5-H0.js";import{i as A}from"../chunks/BdvQLAZU.js";import{r as F}from"../chunks/BfIrQ_zr.js";import{e as N}from"../chunks/DtrBNwtL.js";import{b as D}from"../chunks/Cko499XQ.js";import{i as oe}from"../chunks/CmAcq_e6.js";import{g as w}from"../chunks/0BRe-bZZ.js";var ie=O('<div class="error svelte-1x05zx6"> </div>'),le=O('<div class="message svelte-1x05zx6"> </div>'),ce=O('<label class="svelte-1x05zx6">Password <input name="password" type="password" autocomplete="current-password" class="svelte-1x05zx6"/></label> <button class="login-btn svelte-1x05zx6"> </button>',1),de=O('<label class="svelte-1x05zx6">OTP <input name="otp" autocomplete="one-time-code" class="svelte-1x05zx6"/></label> <button class="login-btn svelte-1x05zx6"> </button>',1),fe=O('<button class="login-btn svelte-1x05zx6"> </button>'),ue=O('<section class="login-viewport svelte-1x05zx6"><div class="login-container svelte-1x05zx6"><div class="login-section svelte-1x05zx6"><div class="brand svelte-1x05zx6"><div class="logo svelte-1x05zx6">RAMS</div> <div class="title svelte-1x05zx6">Residence Access Management System</div></div> <div class="login-form svelte-1x05zx6"><h2 class="svelte-1x05zx6">Login</h2> <!> <!> <label class="svelte-1x05zx6">Username <input name="username" autocomplete="username" class="svelte-1x05zx6"/></label> <!></div></div></div></section>');function ke(H,X){ae(X,!1);let y=h(""),z=h(""),T=h(""),c=h(null),x=h(null),j=h(!1),f=h(!1),k=h(null);async function C(){if(r(c,null),r(x,null),!s(y).trim()){r(c,"Please enter a username");return}if(await q(),s(k)==="guard"){r(c,"This account is a guard. Please login with password.");return}r(f,!0);try{let l=function(n){try{if(n&&n.type&&typeof n.data=="string"){const d=JSON.parse(n.data);if(Array.isArray(d)&&d.length>0&&typeof d[0]=="object"){const v=d[0],u={};for(const _ of Object.keys(v)){const R=v[_];u[_]=d[R]}return u}return d}}catch{}return n};const e=new FormData;e.append("username",s(y).trim());const i=new URL("/login",location.origin).toString(),a=await fetch(i,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){w(a.url);return}const o=await a.text().catch(()=>null);let t=null;if(o)try{t=JSON.parse(o)}catch{console.warn("sendOtp: response not JSON, using text fallback")}if(!a.ok){console.error("sendOtp: non-ok response",a.status,o),r(c,t?.error||o||"Failed to send OTP");return}t&&typeof t=="object"&&t.type&&(t=l(t)),t?.otpSent?(r(j,!0),r(x,t.message||"OTP sent to your email"),requestAnimationFrame(()=>document.querySelector('input[name="otp"]')?.focus())):o&&!t&&r(x,o)}catch(e){console.error("sendOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(c,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(c,e?.message||"Network error")}finally{r(f,!1)}}async function G(){if(r(c,null),r(x,null),!s(y).trim()){r(c,"Please enter a username");return}if(!s(T).trim()){r(c,"Please enter your password");return}r(f,!0);try{const e=new FormData;e.append("username",s(y).trim()),e.append("password",s(T).trim());const i=new URL("/login",location.origin).toString(),a=await fetch(i,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){w(a.url);return}const o=await a.text().catch(()=>null);let t=null;if(o)try{t=JSON.parse(o)}catch{}if(t&&typeof t=="object"&&t.type)try{const l=JSON.parse(t.data);if(Array.isArray(l)&&l.length>0&&typeof l[0]=="object"){const n=l[0],d={};for(const v of Object.keys(n)){const u=n[v];d[v]=l[u]}t=d}else t=l}catch{}if(!a.ok){r(c,t?.error||o||"Login failed");return}if(t?.success){if(t.redirect){w(t.redirect);return}w("/");return}o&&!t&&r(x,o)}catch(e){console.error("submitGuardPassword: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(c,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(c,e?.message||"Network error")}finally{r(f,!1)}}async function I(){if(r(c,null),r(x,null),!s(z).trim()){r(c,"Please enter the OTP");return}r(f,!0);try{const e=new FormData;e.append("username",s(y).trim()),e.append("otp",s(z).trim());const i=new URL("/login",location.origin).toString(),a=await fetch(i,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){w(a.url);return}const o=await a.text().catch(()=>null);let t=null;if(o)try{t=JSON.parse(o)}catch{console.warn("verifyOtp: response not JSON, using text fallback")}if(t&&typeof t=="object"&&t.type)try{const n=JSON.parse(t.data);if(Array.isArray(n)&&n.length>0&&typeof n[0]=="object"){const d=n[0],v={};for(const u of Object.keys(d)){const _=d[u];v[u]=n[_]}t=v}else t=n}catch{}if(!a.ok){console.error("verifyOtp: non-ok response",a.status,o),r(c,t?.error||o||"OTP verification failed");return}const l=t?.redirect||Array.isArray(t)&&t[2]||null;if(l){w(l);return}if(t?.success){w("/");return}o&&!t&&r(x,o)}catch(e){console.error("verifyOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(c,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(c,e?.message||"Network error")}finally{r(f,!1)}}function M(e){e.key==="Enter"&&(e.preventDefault(),s(k)==="guard"?G():s(j)?I():C())}re(()=>(document.addEventListener("keydown",M),()=>document.removeEventListener("keydown",M)));async function q(){if(r(k,null),!!s(y).trim())try{const e=new URL("/login/identify",location.origin);e.searchParams.set("username",s(y).trim());const i=await fetch(e.toString(),{method:"GET",credentials:"same-origin"});if(!i.ok)return;const a=await i.json().catch(()=>null);a&&a.role&&r(k,a.role)}catch(e){console.warn("identifyUser failed",e)}}oe();var L=ue(),V=p(L),K=p(V),Q=g(p(K),2),W=g(p(Q),2);{var Y=e=>{var i=ie(),a=p(i,!0);m(i),S(()=>P(a,s(c))),b(e,i)};A(W,e=>{s(c)&&e(Y)})}var B=g(W,2);{var Z=e=>{var i=le(),a=p(i,!0);m(i),S(()=>P(a,s(x))),b(e,i)};A(B,e=>{s(x)&&e(Z)})}var J=g(B,2),E=g(p(J));F(E),m(J);var $=g(J,2);{var ee=e=>{var i=ce(),a=U(i),o=g(p(a));F(o),m(a);var t=g(a,2),l=p(t,!0);m(t),S(()=>{t.disabled=s(f),P(l,s(f)?"Logging in...":"Login")}),D(o,()=>s(T),n=>r(T,n)),N("click",t,G),b(e,i)},te=e=>{var i=se(),a=U(i);{var o=l=>{var n=de(),d=U(n),v=g(p(d));F(v),m(d);var u=g(d,2),_=p(u,!0);m(u),S(()=>{u.disabled=s(f),P(_,s(f)?"Verifying...":"Verify OTP")}),D(v,()=>s(z),R=>r(z,R)),N("click",u,I),b(l,n)},t=l=>{var n=fe(),d=p(n,!0);m(n),S(()=>{n.disabled=s(f),P(d,s(f)?"Sending...":"Send OTP")}),N("click",n,C),b(l,n)};A(a,l=>{s(j)?l(o):l(t,!1)})}b(e,i)};A($,e=>{s(k)==="guard"?e(ee):e(te,!1)})}m(Q),m(K),m(V),m(L),D(E,()=>s(y),e=>r(y,e)),N("blur",E,()=>q()),b(H,L),ne()}export{ke as component};
