import"../chunks/DsnmJJEf.js";import"../chunks/Dr5p_gXH.js";import{o as re}from"../chunks/G6y-YXti.js";import{p as ae,f as _,g as n,c as b,d as ne,s as g,e as u,j as r,m as h,r as p,t as k,b as U,aQ as se}from"../chunks/D6_VZFDO.js";import{s as S}from"../chunks/BDSG5-H0.js";import{i as A}from"../chunks/BdvQLAZU.js";import{r as F}from"../chunks/BfIrQ_zr.js";import{e as N}from"../chunks/DtrBNwtL.js";import{b as D}from"../chunks/Cko499XQ.js";import{i as oe}from"../chunks/CmAcq_e6.js";import{g as w}from"../chunks/D9W8X6Gc.js";var ie=_('<div class="error svelte-1x05zx6"> </div>'),le=_('<div class="message svelte-1x05zx6"> </div>'),ce=_('<label class="svelte-1x05zx6">Password <input name="password" type="password" autocomplete="current-password" class="svelte-1x05zx6"/></label> <button class="login-btn svelte-1x05zx6"> </button>',1),de=_('<label class="svelte-1x05zx6">OTP <input name="otp" autocomplete="one-time-code" class="svelte-1x05zx6"/></label> <button class="login-btn svelte-1x05zx6"> </button>',1),fe=_('<button class="login-btn svelte-1x05zx6"> </button>'),ue=_('<section class="login-viewport svelte-1x05zx6"><div class="login-container svelte-1x05zx6"><div class="login-section svelte-1x05zx6"><div class="brand svelte-1x05zx6"><div class="logo svelte-1x05zx6">RAMS</div> <div class="title svelte-1x05zx6">Residence Access Management System</div></div> <div class="login-form svelte-1x05zx6"><h2 class="svelte-1x05zx6">Login</h2> <!> <!> <label class="svelte-1x05zx6">Username <input name="username" autocomplete="username" class="svelte-1x05zx6"/></label> <!></div></div></div></section>');function ke(H,X){ae(X,!1);let y=h(""),P=h(""),z=h(""),c=h(null),x=h(null),j=h(!1),f=h(!1),O=h(null);async function C(){if(r(c,null),r(x,null),!n(y).trim()){r(c,"Please enter a username");return}if(await q(),n(O)==="guard"){r(c,"This account is a guard. Please login with password.");return}r(f,!0);try{let s=function(i){try{if(i&&i.type&&typeof i.data=="string"){const d=JSON.parse(i.data);if(Array.isArray(d)&&d.length>0&&typeof d[0]=="object"){const m=d[0],v={};for(const T of Object.keys(m)){const R=m[T];v[T]=d[R]}return v}return d}}catch{}return i};const e=new FormData;e.append("username",n(y).trim());const l=new URL("/login",location.origin).toString(),a=await fetch(l,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){w(a.url);return}const o=await a.text().catch(()=>null);let t=null;if(o)try{t=JSON.parse(o)}catch{console.warn("sendOtp: response not JSON, using text fallback")}if(!a.ok){console.error("sendOtp: non-ok response",a.status,o),r(c,t?.error||o||"Failed to send OTP");return}t&&typeof t=="object"&&t.type&&(t=s(t)),t?.otpSent?(r(j,!0),r(x,t.message||"OTP sent to your email"),requestAnimationFrame(()=>document.querySelector('input[name="otp"]')?.focus())):o&&!t&&r(x,o)}catch(e){console.error("sendOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(c,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(c,e?.message||"Network error")}finally{r(f,!1)}}async function G(){if(r(c,null),r(x,null),!n(y).trim()){r(c,"Please enter a username");return}if(!n(z).trim()){r(c,"Please enter your password");return}r(f,!0);try{const e=new FormData;e.append("username",n(y).trim()),e.append("password",n(z).trim());const l=new URL("/login",location.origin).toString(),a=await fetch(l,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){w(a.url);return}const o=await a.text().catch(()=>null);let t=null;if(o)try{t=JSON.parse(o)}catch{}if(t&&typeof t=="object"&&t.type)try{const s=JSON.parse(t.data);if(Array.isArray(s)&&s.length>0&&typeof s[0]=="object"){const i=s[0],d={};for(const m of Object.keys(i)){const v=i[m];d[m]=s[v]}t=d}else t=s}catch{}if(!a.ok){r(c,t?.error||o||"Login failed");return}if(t?.success){if(t.redirect){w(t.redirect);return}w("/");return}o&&!t&&r(x,o)}catch(e){console.error("submitGuardPassword: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(c,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(c,e?.message||"Network error")}finally{r(f,!1)}}async function I(){if(r(c,null),r(x,null),!n(P).trim()){r(c,"Please enter the OTP");return}r(f,!0);try{const e=new FormData;e.append("username",n(y).trim()),e.append("otp",n(P).trim());const l=new URL("/login",location.origin).toString(),a=await fetch(l,{method:"POST",body:e,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){w(a.url);return}const o=await a.text().catch(()=>null);let t=null;if(o)try{t=JSON.parse(o)}catch{console.warn("verifyOtp: response not JSON, using text fallback")}if(t&&typeof t=="object"&&t.type)try{const s=JSON.parse(t.data);if(Array.isArray(s)&&s.length>0&&typeof s[0]=="object"){const i=s[0],d={};for(const m of Object.keys(i)){const v=i[m];d[m]=s[v]}t=d}else t=s}catch{}if(!a.ok){console.error("verifyOtp: non-ok response",a.status,o),r(c,t?.error||o||"OTP verification failed");return}if(t?.success){if(t.redirect){w(t.redirect);return}w("/");return}o&&!t&&r(x,o)}catch(e){console.error("verifyOtp: fetch error",e),e instanceof TypeError&&/failed to fetch/i.test(String(e.message))?r(c,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(c,e?.message||"Network error")}finally{r(f,!1)}}function M(e){e.key==="Enter"&&(e.preventDefault(),n(O)==="guard"?G():n(j)?I():C())}re(()=>(document.addEventListener("keydown",M),()=>document.removeEventListener("keydown",M)));async function q(){if(r(O,null),!!n(y).trim())try{const e=new URL("/login/identify",location.origin);e.searchParams.set("username",n(y).trim());const l=await fetch(e.toString(),{method:"GET",credentials:"same-origin"});if(!l.ok)return;const a=await l.json().catch(()=>null);a&&a.role&&r(O,a.role)}catch(e){console.warn("identifyUser failed",e)}}oe();var L=ue(),V=u(L),K=u(V),Q=g(u(K),2),W=g(u(Q),2);{var Y=e=>{var l=ie(),a=u(l,!0);p(l),k(()=>S(a,n(c))),b(e,l)};A(W,e=>{n(c)&&e(Y)})}var B=g(W,2);{var Z=e=>{var l=le(),a=u(l,!0);p(l),k(()=>S(a,n(x))),b(e,l)};A(B,e=>{n(x)&&e(Z)})}var J=g(B,2),E=g(u(J));F(E),p(J);var $=g(J,2);{var ee=e=>{var l=ce(),a=U(l),o=g(u(a));F(o),p(a);var t=g(a,2),s=u(t,!0);p(t),k(()=>{t.disabled=n(f),S(s,n(f)?"Logging in...":"Login")}),D(o,()=>n(z),i=>r(z,i)),N("click",t,G),b(e,l)},te=e=>{var l=se(),a=U(l);{var o=s=>{var i=de(),d=U(i),m=g(u(d));F(m),p(d);var v=g(d,2),T=u(v,!0);p(v),k(()=>{v.disabled=n(f),S(T,n(f)?"Verifying...":"Verify OTP")}),D(m,()=>n(P),R=>r(P,R)),N("click",v,I),b(s,i)},t=s=>{var i=fe(),d=u(i,!0);p(i),k(()=>{i.disabled=n(f),S(d,n(f)?"Sending...":"Send OTP")}),N("click",i,C),b(s,i)};A(a,s=>{n(j)?s(o):s(t,!1)})}b(e,l)};A($,e=>{n(O)==="guard"?e(ee):e(te,!1)})}p(Q),p(K),p(V),p(L),D(E,()=>n(y),e=>r(y,e)),N("blur",E,()=>q()),b(H,L),ne()}export{ke as component};
