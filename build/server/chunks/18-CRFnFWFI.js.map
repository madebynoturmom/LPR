{"version":3,"file":"18-CRFnFWFI.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/login/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/18.js"],"sourcesContent":["import { d as db, b as admin, u as user, s as session } from \"../../../chunks/index3.js\";\nimport { fail, redirect } from \"@sveltejs/kit\";\nimport { v4 } from \"uuid\";\nimport { sha256 } from \"@oslojs/crypto/sha2\";\nimport { encodeHexLowerCase } from \"@oslojs/encoding\";\nimport { eq } from \"drizzle-orm\";\nimport crypto from \"crypto\";\nconst actions = {\n  default: async ({ request, cookies }) => {\n    const form = await request.formData();\n    const username = form.get(\"username\")?.toString().trim();\n    const password = form.get(\"password\")?.toString();\n    if (!username || !password) {\n      return fail(400, { error: \"Username and password are required.\" });\n    }\n    let found = null;\n    let userRole = null;\n    const admins = await db.select().from(admin).where(eq(admin.username, username));\n    if (admins.length > 0) {\n      found = admins[0];\n      userRole = \"admin\";\n    } else {\n      const users = await db.select().from(user).where(eq(user.username, username));\n      if (users.length > 0) {\n        found = users[0];\n        userRole = found.role;\n      }\n    }\n    if (!found) {\n      return fail(401, { error: \"Invalid username or password.\" });\n    }\n    const hash = crypto.createHash(\"sha256\").update(password).digest(\"hex\");\n    if (hash !== found.passwordHash) {\n      return fail(401, { error: \"Invalid username or password.\" });\n    }\n    const sessionToken = v4();\n    const sessionId = encodeHexLowerCase(sha256(new TextEncoder().encode(sessionToken)));\n    const expiresAt = new Date(Date.now() + 1e3 * 60 * 60 * 24 * 7);\n    await db.insert(session).values({\n      id: sessionId,\n      userId: found.id,\n      expiresAt\n    });\n    cookies.set(\"auth-session\", sessionToken, { path: \"/\", httpOnly: true });\n    if (userRole === \"admin\") {\n      throw redirect(303, \"/admin/dashboard\");\n    } else if (userRole === \"guard\") {\n      throw redirect(303, \"/guard/dashboard\");\n    } else if (userRole === \"resident\") {\n      throw redirect(303, \"/user/dashboard\");\n    } else {\n      throw redirect(303, \"/\");\n    }\n  }\n};\nconst load = async () => {\n  return {};\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/login/_page.server.ts.js';\n\nexport const index = 18;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/login/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/login/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/18._XpzMrVP.js\",\"_app/immutable/chunks/DsnmJJEf.js\",\"_app/immutable/chunks/CaduOojm.js\",\"_app/immutable/chunks/c4qruIAv.js\",\"_app/immutable/chunks/CE_Elu-f.js\",\"_app/immutable/chunks/NX4HCjE0.js\",\"_app/immutable/chunks/Cpx9Zc3b.js\"];\nexport const stylesheets = [\"_app/immutable/assets/18.NJqmu5VW.css\"];\nexport const fonts = [];\n"],"names":[],"mappings":";;;;;;;;;AAOA,MAAM,OAAO,GAAG;AAChB,EAAE,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,KAAK;AAC3C,IAAI,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,QAAQ,EAAE;AACzC,IAAI,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,QAAQ,EAAE,CAAC,IAAI,EAAE;AAC5D,IAAI,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,QAAQ,EAAE;AACrD,IAAI,IAAI,CAAC,QAAQ,IAAI,CAAC,QAAQ,EAAE;AAChC,MAAM,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,qCAAqC,EAAE,CAAC;AACxE,IAAI;AACJ,IAAI,IAAI,KAAK,GAAG,IAAI;AACpB,IAAI,IAAI,QAAQ,GAAG,IAAI;AACvB,IAAI,MAAM,MAAM,GAAG,MAAM,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;AACpF,IAAI,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;AAC3B,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC;AACvB,MAAM,QAAQ,GAAG,OAAO;AACxB,IAAI,CAAC,MAAM;AACX,MAAM,MAAM,KAAK,GAAG,MAAM,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;AACnF,MAAM,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;AAC5B,QAAQ,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC;AACxB,QAAQ,QAAQ,GAAG,KAAK,CAAC,IAAI;AAC7B,MAAM;AACN,IAAI;AACJ,IAAI,IAAI,CAAC,KAAK,EAAE;AAChB,MAAM,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,+BAA+B,EAAE,CAAC;AAClE,IAAI;AACJ,IAAI,MAAM,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;AAC3E,IAAI,IAAI,IAAI,KAAK,KAAK,CAAC,YAAY,EAAE;AACrC,MAAM,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,+BAA+B,EAAE,CAAC;AAClE,IAAI;AACJ,IAAI,MAAM,YAAY,GAAG,EAAE,EAAE;AAC7B,IAAI,MAAM,SAAS,GAAG,kBAAkB,CAAC,MAAM,CAAC,IAAI,WAAW,EAAE,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC;AACxF,IAAI,MAAM,SAAS,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,GAAG,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,CAAC,CAAC;AACnE,IAAI,MAAM,EAAE,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC;AACpC,MAAM,EAAE,EAAE,SAAS;AACnB,MAAM,MAAM,EAAE,KAAK,CAAC,EAAE;AACtB,MAAM;AACN,KAAK,CAAC;AACN,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,YAAY,EAAE,EAAE,IAAI,EAAE,GAAG,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC;AAC5E,IAAI,IAAI,QAAQ,KAAK,OAAO,EAAE;AAC9B,MAAM,MAAM,QAAQ,CAAC,GAAG,EAAE,kBAAkB,CAAC;AAC7C,IAAI,CAAC,MAAM,IAAI,QAAQ,KAAK,OAAO,EAAE;AACrC,MAAM,MAAM,QAAQ,CAAC,GAAG,EAAE,kBAAkB,CAAC;AAC7C,IAAI,CAAC,MAAM,IAAI,QAAQ,KAAK,UAAU,EAAE;AACxC,MAAM,MAAM,QAAQ,CAAC,GAAG,EAAE,iBAAiB,CAAC;AAC5C,IAAI,CAAC,MAAM;AACX,MAAM,MAAM,QAAQ,CAAC,GAAG,EAAE,GAAG,CAAC;AAC9B,IAAI;AACJ,EAAE;AACF,CAAC;AACD,MAAM,IAAI,GAAG,YAAY;AACzB,EAAE,OAAO,EAAE;AACX,CAAC;;;;;;;;ACvDW,MAAC,KAAK,GAAG;AACrB,IAAI,eAAe;AACP,MAAC,SAAS,GAAG,YAAY,eAAe,KAAK,CAAC,MAAM,OAAO,4BAAwC,CAAC,EAAE;AAEtG,MAAC,SAAS,GAAG;AACb,MAAC,OAAO,GAAG,CAAC,qCAAqC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC;AACzQ,MAAC,WAAW,GAAG,CAAC,uCAAuC;AACvD,MAAC,KAAK,GAAG;;;;"}