{"version":3,"file":"20-X5YjDIKS.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/guard/dashboard/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/20.js"],"sourcesContent":["import { d as db, g as guestPass, f as guestPassHistory, e as eventLog } from \"../../../../chunks/index3.js\";\nimport { fail } from \"@sveltejs/kit\";\nimport { eq } from \"drizzle-orm\";\nfunction requireGuard(locals) {\n  if (!locals.user) return { ok: false, status: 401, message: \"Not authenticated.\" };\n  if (locals.user.role !== \"guard\") return { ok: false, status: 403, message: \"Forbidden: guard role required.\" };\n  return { ok: true, user: locals.user };\n}\nconst load = async ({ locals }) => {\n  const check = requireGuard(locals);\n  if (!check.ok) return { activeVisitorPasses: [], activeFoodDeliveryPasses: [], recentCarAccess: [] };\n  const now = Math.floor(Date.now() / 1e3);\n  const allVisitors = await db.select().from(guestPass).where(eq(guestPass.type, \"visitors\"));\n  const activeVisitorPasses = allVisitors.filter((pass) => {\n    const visitTimeSeconds = Math.floor(new Date(pass.visitTime).getTime() / 1e3);\n    const expirationTime = visitTimeSeconds + pass.durationMinutes * 60;\n    return pass.status === \"active\" && now < expirationTime;\n  }).map((p) => ({ ...p, visitTime: new Date(p.visitTime).toISOString() }));\n  const allFood = await db.select().from(guestPass).where(eq(guestPass.type, \"food_delivery\"));\n  const activeFoodDeliveryPasses = allFood.filter((pass) => {\n    const visitTimeSeconds = Math.floor(new Date(pass.visitTime).getTime() / 1e3);\n    const expirationTime = visitTimeSeconds + pass.durationMinutes * 60;\n    return pass.status === \"active\" && now < expirationTime;\n  }).map((p) => ({ ...p, visitTime: new Date(p.visitTime).toISOString() }));\n  const recentRows = await db.all(`SELECT id, type, details, timestamp FROM event_log ORDER BY timestamp DESC LIMIT 10;`);\n  const recentCarAccess = Array.isArray(recentRows) ? recentRows : [];\n  return { activeVisitorPasses, activeFoodDeliveryPasses, recentCarAccess };\n};\nconst actions = {\n  admit: async ({ request, locals }) => {\n    const check = requireGuard(locals);\n    if (!check.ok) return fail(check.status ?? 403, { error: check.message });\n    const form = await request.formData();\n    const id = form.get(\"id\")?.toString();\n    if (!id) return fail(400, { error: \"Missing pass id\" });\n    const pass = await db.select().from(guestPass).where(eq(guestPass.id, id)).get();\n    if (!pass) return fail(404, { error: \"Pass not found\" });\n    const now = Math.floor(Date.now() / 1e3);\n    const visitTimeSeconds = Math.floor(new Date(pass.visitTime).getTime() / 1e3);\n    const expirationTime = visitTimeSeconds + pass.durationMinutes * 60;\n    if (pass.status !== \"active\" || now >= expirationTime) return fail(400, { error: \"Pass is not active or has expired\" });\n    try {\n      const guardUser = check.user;\n      await db.insert(eventLog).values({ id: `E${Date.now()}`, type: \"vehicle_entry\", userId: guardUser.id, details: `Admitted pass ${pass.id} (${pass.plateNumber}) by guard ${guardUser.username}`, timestamp: /* @__PURE__ */ new Date() });\n      return { success: true };\n    } catch (e) {\n      return fail(500, { error: \"Failed to admit pass.\" });\n    }\n  },\n  deny: async ({ request, locals }) => {\n    const check = requireGuard(locals);\n    if (!check.ok) return fail(check.status ?? 403, { error: check.message });\n    const form = await request.formData();\n    const id = form.get(\"id\")?.toString();\n    if (!id) return fail(400, { error: \"Missing pass id\" });\n    const pass = await db.select().from(guestPass).where(eq(guestPass.id, id)).get();\n    if (!pass) return fail(404, { error: \"Pass not found\" });\n    if (pass.status !== \"active\") return fail(400, { error: \"Pass is not active\" });\n    try {\n      await db.insert(guestPassHistory).values({ id: pass.id, plateNumber: pass.plateNumber, visitTime: new Date(pass.visitTime), durationMinutes: pass.durationMinutes, status: \"revoked\", userId: pass.userId, type: pass.type, revokedAt: /* @__PURE__ */ new Date(), name: pass.name, phone: pass.phone });\n      await db.delete(guestPass).where(eq(guestPass.id, id));\n      const guardUser = check.user;\n      await db.insert(eventLog).values({ id: `E${Date.now()}`, type: \"access_denied\", userId: guardUser.id, details: `Denied pass ${pass.id} (${pass.plateNumber}) by guard ${guardUser.username}`, timestamp: /* @__PURE__ */ new Date() });\n      return { success: true };\n    } catch (e) {\n      return fail(500, { error: \"Failed to deny pass.\" });\n    }\n  }\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/guard/dashboard/_page.server.ts.js';\n\nexport const index = 20;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/guard/dashboard/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/guard/dashboard/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/20.B42nURwR.js\",\"_app/immutable/chunks/DsnmJJEf.js\",\"_app/immutable/chunks/Dr5p_gXH.js\",\"_app/immutable/chunks/D6_VZFDO.js\",\"_app/immutable/chunks/BDSG5-H0.js\",\"_app/immutable/chunks/DtrBNwtL.js\",\"_app/immutable/chunks/BHQlukOt.js\",\"_app/immutable/chunks/BdvQLAZU.js\",\"_app/immutable/chunks/g0qwyJPX.js\",\"_app/immutable/chunks/BfIrQ_zr.js\",\"_app/immutable/chunks/Cko499XQ.js\",\"_app/immutable/chunks/CmAcq_e6.js\",\"_app/immutable/chunks/BWorSmfV.js\",\"_app/immutable/chunks/DPinqpzW.js\",\"_app/immutable/chunks/DDKRNP9O.js\"];\nexport const stylesheets = [\"_app/immutable/assets/20.Dxm5GUdE.css\"];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}