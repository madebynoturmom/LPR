{"version":3,"file":"19-vLG5TicG.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/login/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/19.js"],"sourcesContent":["import { d as db, a as admin, u as user, o as otp } from \"../../../chunks/index3.js\";\nimport { fail, redirect } from \"@sveltejs/kit\";\nimport { v4 } from \"uuid\";\nimport \"@oslojs/crypto/sha2\";\nimport \"@oslojs/encoding\";\nimport { eq, desc } from \"drizzle-orm\";\nimport { g as generateSessionToken, c as createSession, s as setSessionTokenCookie } from \"../../../chunks/auth.js\";\nimport { s as sendEmail } from \"../../../chunks/email.js\";\nconst actions = {\n  default: async (event) => {\n    console.log(\"🔐 Login Action: Starting\");\n    const { request } = event;\n    const form = await request.formData();\n    const username = form.get(\"username\")?.toString().trim();\n    const otpCode = form.get(\"otp\")?.toString().trim();\n    console.log(\"🔐 Received form data: username=\", username, \"otpCode=\", otpCode ? \"provided\" : \"not provided\");\n    if (!username) {\n      return fail(400, { error: \"Username is required.\" });\n    }\n    let found = null;\n    let userRole = null;\n    let userEmail = null;\n    const admins = await db.select().from(admin).where(eq(admin.username, username));\n    if (admins.length > 0) {\n      found = admins[0];\n      userRole = \"admin\";\n      userEmail = found.email;\n    } else {\n      const users = await db.select().from(user).where(eq(user.username, username));\n      if (users.length > 0) {\n        found = users[0];\n        userRole = found.role;\n        userEmail = found.email;\n      }\n    }\n    if (!found) {\n      console.log(\"🔐 User not found for username:\", username);\n      return fail(401, { error: \"Invalid username.\" });\n    }\n    if (!userEmail) {\n      console.log(\"🔐 No email associated with user:\", username);\n      return fail(400, { error: \"No email associated with this user.\" });\n    }\n    console.log(\"🔐 User found:\", username, \"Role:\", userRole, \"Email:\", userEmail);\n    if (!otpCode) {\n      console.log(\"🔐 OTP Generation: Starting for username:\", username);\n      const code = Math.floor(1e5 + Math.random() * 9e5).toString();\n      console.log(\"🔐 OTP Generated:\", code, \"for email:\", userEmail);\n      const expiresAt = new Date(Date.now() + 5 * 60 * 1e3);\n      console.log(\"🔐 OTP Expires At:\", expiresAt);\n      await db.insert(otp).values({\n        id: v4(),\n        email: userEmail,\n        code,\n        expiresAt\n      });\n      console.log(\"🔐 OTP Stored in DB\");\n      console.log(\"📧 SMTP_USER set:\", !!process.env.SMTP_USER);\n      console.log(\"📧 SMTP_PASS set:\", !!process.env.SMTP_PASS);\n      console.log(\"📧 Sending OTP email to:\", userEmail);\n      try {\n        await sendEmail(userEmail, \"Your OTP Code\", `Your OTP code is: ${code}`);\n        console.log(\"📧 OTP Email sent successfully\");\n      } catch (emailError) {\n        console.error(\"📧 OTP Email send failed:\", emailError);\n        return fail(500, { error: \"Failed to send OTP email. Please try again.\" });\n      }\n      const body = { otpSent: true, message: \"OTP sent to your email.\" };\n      console.log(\"🔐 Sending back response (action):\", body);\n      return body;\n    } else {\n      console.log(\"🔐 OTP Verification: Starting for email:\", userEmail, \"OTP:\", otpCode);\n      const otpRecords = await db.select().from(otp).where(eq(otp.email, userEmail)).orderBy(desc(otp.expiresAt));\n      console.log(\"🔐 OTP Records found:\", otpRecords.length);\n      if (otpRecords.length === 0) {\n        console.log(\"🔐 No OTP records found for email:\", userEmail);\n        return fail(401, { error: \"No OTP found. Please request a new one.\" });\n      }\n      const latestOtp = otpRecords[0];\n      console.log(\"🔐 Latest OTP:\", latestOtp.code, \"Expires:\", latestOtp.expiresAt);\n      const otpExpiresAt = typeof latestOtp.expiresAt === \"number\" ? latestOtp.expiresAt : new Date(latestOtp.expiresAt).getTime();\n      if (Date.now() > otpExpiresAt) {\n        console.log(\"🔐 OTP expired\");\n        return fail(401, { error: \"OTP expired. Please request a new one.\" });\n      }\n      if (latestOtp.code !== otpCode) {\n        console.log(\"🔐 OTP mismatch: provided\", otpCode, \"stored\", latestOtp.code);\n        return fail(401, { error: \"Invalid OTP.\" });\n      }\n      console.log(\"🔐 OTP verified successfully\");\n      await db.delete(otp).where(eq(otp.id, latestOtp.id));\n      console.log(\"🔐 OTP deleted from DB\");\n      const sessionToken = generateSessionToken();\n      const session = await createSession(sessionToken, found.id);\n      setSessionTokenCookie(event, sessionToken, session.expiresAt);\n      const redirectUrl = userRole === \"admin\" ? \"/admin/dashboard\" : userRole === \"guard\" ? \"/guard/dashboard\" : userRole === \"resident\" ? \"/user/dashboard\" : \"/\";\n      const accept = request.headers.get(\"accept\") || \"\";\n      if (accept.includes(\"application/json\")) {\n        return { success: true, redirect: redirectUrl };\n      }\n      throw redirect(303, redirectUrl);\n    }\n  }\n};\nconst load = async () => {\n  return {};\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/login/_page.server.ts.js';\n\nexport const index = 19;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/login/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/login/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/19.CS8Xwox6.js\",\"_app/immutable/chunks/DsnmJJEf.js\",\"_app/immutable/chunks/COTvsYcR.js\",\"_app/immutable/chunks/BjJWVY7i.js\",\"_app/immutable/chunks/DQtEjgo4.js\",\"_app/immutable/chunks/DyiMSgY8.js\",\"_app/immutable/chunks/CbnbkC1n.js\",\"_app/immutable/chunks/BN32gUog.js\",\"_app/immutable/chunks/C26tcRC5.js\",\"_app/immutable/chunks/D6O3RN6I.js\",\"_app/immutable/chunks/DWyjkCdo.js\",\"_app/immutable/chunks/Btu2CQ7A.js\",\"_app/immutable/chunks/BbceK8gy.js\",\"_app/immutable/chunks/Bz7ZLckS.js\",\"_app/immutable/chunks/ZMIOfXK-.js\",\"_app/immutable/chunks/CmONDsb2.js\"];\nexport const stylesheets = [\"_app/immutable/assets/19._94_Grtu.css\"];\nexport const fonts = [];\n"],"names":[],"mappings":";;;;;;;;;;;AAQA,MAAM,OAAO,GAAG;AAChB,EAAE,OAAO,EAAE,OAAO,KAAK,KAAK;AAC5B,IAAI,OAAO,CAAC,GAAG,CAAC,2BAA2B,CAAC;AAC5C,IAAI,MAAM,EAAE,OAAO,EAAE,GAAG,KAAK;AAC7B,IAAI,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,QAAQ,EAAE;AACzC,IAAI,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,QAAQ,EAAE,CAAC,IAAI,EAAE;AAC5D,IAAI,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,QAAQ,EAAE,CAAC,IAAI,EAAE;AACtD,IAAI,OAAO,CAAC,GAAG,CAAC,kCAAkC,EAAE,QAAQ,EAAE,UAAU,EAAE,OAAO,GAAG,UAAU,GAAG,cAAc,CAAC;AAChH,IAAI,IAAI,CAAC,QAAQ,EAAE;AACnB,MAAM,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,uBAAuB,EAAE,CAAC;AAC1D,IAAI;AACJ,IAAI,IAAI,KAAK,GAAG,IAAI;AACpB,IAAI,IAAI,QAAQ,GAAG,IAAI;AACvB,IAAI,IAAI,SAAS,GAAG,IAAI;AACxB,IAAI,MAAM,MAAM,GAAG,MAAM,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;AACpF,IAAI,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;AAC3B,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC;AACvB,MAAM,QAAQ,GAAG,OAAO;AACxB,MAAM,SAAS,GAAG,KAAK,CAAC,KAAK;AAC7B,IAAI,CAAC,MAAM;AACX,MAAM,MAAM,KAAK,GAAG,MAAM,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;AACnF,MAAM,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;AAC5B,QAAQ,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC;AACxB,QAAQ,QAAQ,GAAG,KAAK,CAAC,IAAI;AAC7B,QAAQ,SAAS,GAAG,KAAK,CAAC,KAAK;AAC/B,MAAM;AACN,IAAI;AACJ,IAAI,IAAI,CAAC,KAAK,EAAE;AAChB,MAAM,OAAO,CAAC,GAAG,CAAC,iCAAiC,EAAE,QAAQ,CAAC;AAC9D,MAAM,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,mBAAmB,EAAE,CAAC;AACtD,IAAI;AACJ,IAAI,IAAI,CAAC,SAAS,EAAE;AACpB,MAAM,OAAO,CAAC,GAAG,CAAC,mCAAmC,EAAE,QAAQ,CAAC;AAChE,MAAM,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,qCAAqC,EAAE,CAAC;AACxE,IAAI;AACJ,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,QAAQ,EAAE,SAAS,CAAC;AACnF,IAAI,IAAI,CAAC,OAAO,EAAE;AAClB,MAAM,OAAO,CAAC,GAAG,CAAC,2CAA2C,EAAE,QAAQ,CAAC;AACxE,MAAM,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC,CAAC,QAAQ,EAAE;AACnE,MAAM,OAAO,CAAC,GAAG,CAAC,mBAAmB,EAAE,IAAI,EAAE,YAAY,EAAE,SAAS,CAAC;AACrE,MAAM,MAAM,SAAS,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,GAAG,EAAE,GAAG,GAAG,CAAC;AAC3D,MAAM,OAAO,CAAC,GAAG,CAAC,oBAAoB,EAAE,SAAS,CAAC;AAClD,MAAM,MAAM,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC;AAClC,QAAQ,EAAE,EAAE,EAAE,EAAE;AAChB,QAAQ,KAAK,EAAE,SAAS;AACxB,QAAQ,IAAI;AACZ,QAAQ;AACR,OAAO,CAAC;AACR,MAAM,OAAO,CAAC,GAAG,CAAC,qBAAqB,CAAC;AACxC,MAAM,OAAO,CAAC,GAAG,CAAC,mBAAmB,EAAE,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC;AAC/D,MAAM,OAAO,CAAC,GAAG,CAAC,mBAAmB,EAAE,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC;AAC/D,MAAM,OAAO,CAAC,GAAG,CAAC,0BAA0B,EAAE,SAAS,CAAC;AACxD,MAAM,IAAI;AACV,QAAQ,MAAM,SAAS,CAAC,SAAS,EAAE,eAAe,EAAE,CAAC,kBAAkB,EAAE,IAAI,CAAC,CAAC,CAAC;AAChF,QAAQ,OAAO,CAAC,GAAG,CAAC,gCAAgC,CAAC;AACrD,MAAM,CAAC,CAAC,OAAO,UAAU,EAAE;AAC3B,QAAQ,OAAO,CAAC,KAAK,CAAC,2BAA2B,EAAE,UAAU,CAAC;AAC9D,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,6CAA6C,EAAE,CAAC;AAClF,MAAM;AACN,MAAM,MAAM,IAAI,GAAG,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,yBAAyB,EAAE;AACxE,MAAM,OAAO,CAAC,GAAG,CAAC,oCAAoC,EAAE,IAAI,CAAC;AAC7D,MAAM,OAAO,IAAI;AACjB,IAAI,CAAC,MAAM;AACX,MAAM,OAAO,CAAC,GAAG,CAAC,0CAA0C,EAAE,SAAS,EAAE,MAAM,EAAE,OAAO,CAAC;AACzF,MAAM,MAAM,UAAU,GAAG,MAAM,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,CAAC,KAAK,EAAE,SAAS,CAAC,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;AACjH,MAAM,OAAO,CAAC,GAAG,CAAC,uBAAuB,EAAE,UAAU,CAAC,MAAM,CAAC;AAC7D,MAAM,IAAI,UAAU,CAAC,MAAM,KAAK,CAAC,EAAE;AACnC,QAAQ,OAAO,CAAC,GAAG,CAAC,oCAAoC,EAAE,SAAS,CAAC;AACpE,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,yCAAyC,EAAE,CAAC;AAC9E,MAAM;AACN,MAAM,MAAM,SAAS,GAAG,UAAU,CAAC,CAAC,CAAC;AACrC,MAAM,OAAO,CAAC,GAAG,CAAC,gBAAgB,EAAE,SAAS,CAAC,IAAI,EAAE,UAAU,EAAE,SAAS,CAAC,SAAS,CAAC;AACpF,MAAM,MAAM,YAAY,GAAG,OAAO,SAAS,CAAC,SAAS,KAAK,QAAQ,GAAG,SAAS,CAAC,SAAS,GAAG,IAAI,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,OAAO,EAAE;AAClI,MAAM,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,YAAY,EAAE;AACrC,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB,CAAC;AACrC,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,wCAAwC,EAAE,CAAC;AAC7E,MAAM;AACN,MAAM,IAAI,SAAS,CAAC,IAAI,KAAK,OAAO,EAAE;AACtC,QAAQ,OAAO,CAAC,GAAG,CAAC,2BAA2B,EAAE,OAAO,EAAE,QAAQ,EAAE,SAAS,CAAC,IAAI,CAAC;AACnF,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,cAAc,EAAE,CAAC;AACnD,MAAM;AACN,MAAM,OAAO,CAAC,GAAG,CAAC,8BAA8B,CAAC;AACjD,MAAM,MAAM,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,EAAE,SAAS,CAAC,EAAE,CAAC,CAAC;AAC1D,MAAM,OAAO,CAAC,GAAG,CAAC,wBAAwB,CAAC;AAC3C,MAAM,MAAM,YAAY,GAAG,oBAAoB,EAAE;AACjD,MAAM,MAAM,OAAO,GAAG,MAAM,aAAa,CAAC,YAAY,EAAE,KAAK,CAAC,EAAE,CAAC;AACjE,MAAM,qBAAqB,CAAC,KAAK,EAAE,YAAY,EAAE,OAAO,CAAC,SAAS,CAAC;AACnE,MAAM,MAAM,WAAW,GAAG,QAAQ,KAAK,OAAO,GAAG,kBAAkB,GAAG,QAAQ,KAAK,OAAO,GAAG,kBAAkB,GAAG,QAAQ,KAAK,UAAU,GAAG,iBAAiB,GAAG,GAAG;AACnK,MAAM,MAAM,MAAM,GAAG,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,EAAE;AACxD,MAAM,IAAI,MAAM,CAAC,QAAQ,CAAC,kBAAkB,CAAC,EAAE;AAC/C,QAAQ,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,WAAW,EAAE;AACvD,MAAM;AACN,MAAM,MAAM,QAAQ,CAAC,GAAG,EAAE,WAAW,CAAC;AACtC,IAAI;AACJ,EAAE;AACF,CAAC;AACD,MAAM,IAAI,GAAG,YAAY;AACzB,EAAE,OAAO,EAAE;AACX,CAAC;;;;;;;;ACxGW,MAAC,KAAK,GAAG;AACrB,IAAI,eAAe;AACP,MAAC,SAAS,GAAG,YAAY,eAAe,KAAK,CAAC,MAAM,OAAO,4BAAwC,CAAC,EAAE;AAEtG,MAAC,SAAS,GAAG;AACb,MAAC,OAAO,GAAG,CAAC,qCAAqC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC;AAC7kB,MAAC,WAAW,GAAG,CAAC,uCAAuC;AACvD,MAAC,KAAK,GAAG;;;;"}