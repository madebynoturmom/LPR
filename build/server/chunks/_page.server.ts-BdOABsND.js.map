{"version":3,"file":"_page.server.ts-BdOABsND.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/admin/dashboard/_page.server.ts.js"],"sourcesContent":["import { d as db, u as user, b as guard, v as vehicle, a as admin, g as guestPass, e as eventLog } from \"../../../../chunks/index3.js\";\nimport { eq, sql, and } from \"drizzle-orm\";\nconst load = async ({ locals }) => {\n  const [residents, guards, vehicles, users, admins, guests, events] = await Promise.all([\n    db.select().from(user).where(eq(user.role, \"resident\")),\n    db.select().from(guard),\n    db.select().from(vehicle),\n    db.select().from(user),\n    db.select().from(admin),\n    db.select().from(guestPass),\n    db.select().from(eventLog)\n  ]);\n  const guestStatsRows = await db.all(\n    sql`\n      SELECT date, SUM(count) as count FROM (\n        SELECT strftime('%Y-%m-%d', datetime(visit_time, 'unixepoch')) as date, COUNT(*) as count\n        FROM guest_pass\n        WHERE visit_time >= strftime('%s', 'now', '-6 days')\n        GROUP BY date\n        UNION ALL\n        SELECT strftime('%Y-%m-%d', datetime(visit_time, 'unixepoch')) as date, COUNT(*) as count\n        FROM guest_pass_history\n        WHERE visit_time >= strftime('%s', 'now', '-6 days')\n        GROUP BY date\n      ) GROUP BY date ORDER BY date ASC;\n    `\n  );\n  const guestStats = Array.isArray(guestStatsRows) ? guestStatsRows.map((row) => ({ date: row.date, count: Number(row.count) })) : [];\n  const allActiveGuestPasses = await db.select().from(guestPass).where(\n    and(\n      eq(guestPass.status, \"active\"),\n      eq(guestPass.type, \"visitors\")\n    )\n  );\n  const now = Math.floor(Date.now() / 1e3);\n  const activeGuestPasses = allActiveGuestPasses.filter((pass) => {\n    const visitTimeSeconds = Math.floor(pass.visitTime.getTime() / 1e3);\n    const expirationTime = visitTimeSeconds + pass.durationMinutes * 60;\n    return now < expirationTime;\n  }).length;\n  const allActiveFoodDeliveryPasses = await db.select().from(guestPass).where(\n    and(\n      eq(guestPass.status, \"active\"),\n      eq(guestPass.type, \"food_delivery\")\n    )\n  );\n  const activeFoodDeliveryPasses = allActiveFoodDeliveryPasses.filter((pass) => {\n    const visitTimeSeconds = Math.floor(pass.visitTime.getTime() / 1e3);\n    const expirationTime = visitTimeSeconds + pass.durationMinutes * 60;\n    return now < expirationTime;\n  }).length;\n  const recentCarAccessRows = await db.all(\n    sql`SELECT details, timestamp FROM event_log WHERE type LIKE '%vehicle%' ORDER BY timestamp DESC LIMIT 1;`\n  );\n  const recentCarAccess = recentCarAccessRows[0] ? `${recentCarAccessRows[0].details} at ${new Date(recentCarAccessRows[0].timestamp * 1e3).toLocaleString()}` : \"N/A\";\n  let adminUsername = \"\";\n  let adminProfilePic = \"\";\n  if (locals.user && locals.user.id) {\n    const [adminRow] = await db.select().from(admin).where(eq(admin.id, locals.user.id));\n    if (adminRow) {\n      adminUsername = adminRow.username;\n      adminProfilePic = adminRow.profilePic || \"\";\n    }\n  }\n  return {\n    residents: residents.length,\n    guards: guards.length,\n    vehicles: vehicles.length,\n    users: users.length,\n    admins: admins.length,\n    guests: guests.length,\n    events: events.length,\n    guestStats,\n    activeGuestPasses,\n    activeFoodDeliveryPasses,\n    recentCarAccess,\n    adminUsername,\n    adminProfilePic\n  };\n};\nexport {\n  load\n};\n"],"names":["vehicle"],"mappings":"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"}