import"../chunks/DsnmJJEf.js";import"../chunks/i9DHmAX1.js";import{o as le}from"../chunks/BQQlMUYl.js";import{f as T,d as m,r as p,t as E,b as k,p as ce,c as de,e as b,i as G,g as o,m as z,s as r,aT as fe}from"../chunks/MgvKJ5Oe.js";import{s as F}from"../chunks/tNEdk8z3.js";import{i as I}from"../chunks/uYRH7WDe.js";import{c as ue}from"../chunks/BVWhRRat.js";import{r as K}from"../chunks/STPvjbMu.js";import{e as M}from"../chunks/DANlTl3y.js";import{b as W}from"../chunks/5UxS6Hio.js";import{i as me}from"../chunks/mO3J0t2N.js";import{g as A}from"../chunks/CK-fib3O.js";import{s as pe}from"../chunks/EO6i301i.js";import{s as ve}from"../chunks/DbZgNqix.js";import{s as ge}from"../chunks/CBbLTMDG.js";import{p as te}from"../chunks/BifvwZtI.js";var ye=T("<div><!></div>");function xe(q,L){let v=te(L,"className",8,""),N=te(L,"padding",8,"2.25rem");var y=ye(),n=m(y);pe(n,L,"default",{}),p(y),E(()=>{ve(y,1,`card ${v()??""}`,"svelte-14efj7c"),ge(y,`--card-padding: ${N()??""}`)}),k(q,y)}var he=T('<div class="error svelte-1x05zx6"> </div>'),be=T('<div class="message svelte-1x05zx6"> </div>'),we=T('<label class="svelte-1x05zx6">Password <input name="password" type="password" autocomplete="current-password" class="svelte-1x05zx6"/></label> <button class="login-btn svelte-1x05zx6"> </button>',1),_e=T('<label class="svelte-1x05zx6">OTP <input name="otp" autocomplete="one-time-code" class="svelte-1x05zx6"/></label> <button class="login-btn svelte-1x05zx6"> </button>',1),Oe=T('<button class="login-btn svelte-1x05zx6"> </button>'),ke=T('<div class="brand svelte-1x05zx6"><div class="logo svelte-1x05zx6">RAMS</div> <div class="title svelte-1x05zx6">Residence Access Management System</div></div> <div class="login-form svelte-1x05zx6"><h2 class="svelte-1x05zx6">Login</h2> <!> <!> <label class="svelte-1x05zx6">Username <input name="username" autocomplete="username" class="svelte-1x05zx6"/></label> <!></div>',1),Se=T('<section class="login-viewport svelte-1x05zx6"><div class="login-container svelte-1x05zx6"><!></div></section>');function Me(q,L){ce(L,!1);let v=z(""),N=z(""),y=z(""),n=z(null),w=z(null),V=z(!1),u=z(!1),J=z(null);async function B(){if(r(n,null),r(w,null),!o(v).trim()){r(n,"Please enter a username");return}if(await Y(),o(J)==="guard"){r(n,"This account is a guard. Please login with password.");return}r(u,!0);try{let l=function(s){try{if(s&&s.type&&typeof s.data=="string"){const d=JSON.parse(s.data);if(Array.isArray(d)&&d.length>0&&typeof d[0]=="object"){const g=d[0],_={};for(const S of Object.keys(g)){const R=g[S];_[S]=d[R]}return _}return d}}catch{}return s};const t=new FormData;t.append("username",o(v).trim());const x=new URL("/login",location.origin).toString(),a=await fetch(x,{method:"POST",body:t,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){A(a.url);return}const i=await a.text().catch(()=>null);let e=null;if(i)try{e=JSON.parse(i)}catch{console.warn("sendOtp: response not JSON, using text fallback")}if(!a.ok){console.error("sendOtp: non-ok response",a.status,i),r(n,e?.error||i||"Failed to send OTP");return}e&&typeof e=="object"&&e.type&&(e=l(e)),e?.otpSent?(r(V,!0),r(w,e.message||"OTP sent to your email"),requestAnimationFrame(()=>document.querySelector('input[name="otp"]')?.focus())):i&&!e&&r(w,i)}catch(t){console.error("sendOtp: fetch error",t),t instanceof TypeError&&/failed to fetch/i.test(String(t.message))?r(n,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(n,t?.message||"Network error")}finally{r(u,!1)}}async function H(){if(r(n,null),r(w,null),!o(v).trim()){r(n,"Please enter a username");return}if(!o(y).trim()){r(n,"Please enter your password");return}r(u,!0);try{const t=new FormData;t.append("username",o(v).trim()),t.append("password",o(y).trim());const x=new URL("/login",location.origin).toString(),a=await fetch(x,{method:"POST",body:t,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){A(a.url);return}const i=await a.text().catch(()=>null);let e=null;if(i)try{e=JSON.parse(i)}catch{}if(e&&typeof e=="object"&&e.type)try{const l=JSON.parse(e.data);if(Array.isArray(l)&&l.length>0&&typeof l[0]=="object"){const s=l[0],d={};for(const g of Object.keys(s)){const _=s[g];d[g]=l[_]}e=d}else e=l}catch{}if(!a.ok){r(n,e?.error||i||"Login failed");return}if(e?.success){if(e.redirect){A(e.redirect);return}A("/");return}i&&!e&&r(w,i)}catch(t){console.error("submitGuardPassword: fetch error",t),t instanceof TypeError&&/failed to fetch/i.test(String(t.message))?r(n,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(n,t?.message||"Network error")}finally{r(u,!1)}}async function Q(){if(r(n,null),r(w,null),!o(N).trim()){r(n,"Please enter the OTP");return}r(u,!0);try{const t=new FormData;t.append("username",o(v).trim()),t.append("otp",o(N).trim());const x=new URL("/login",location.origin).toString(),a=await fetch(x,{method:"POST",body:t,headers:{Accept:"application/json"},credentials:"same-origin"});if(a.redirected){A(a.url);return}const i=await a.text().catch(()=>null);let e=null;if(i)try{e=JSON.parse(i)}catch{console.warn("verifyOtp: response not JSON, using text fallback")}if(e&&typeof e=="object"&&e.type)try{const s=JSON.parse(e.data);if(Array.isArray(s)&&s.length>0&&typeof s[0]=="object"){const d=s[0],g={};for(const _ of Object.keys(d)){const S=d[_];g[_]=s[S]}e=g}else e=s}catch{}if(!a.ok){console.error("verifyOtp: non-ok response",a.status,i),r(n,e?.error||i||"OTP verification failed");return}const l=e?.redirect||Array.isArray(e)&&e[2]||null;if(l){A(l);return}if(e?.success){A("/");return}i&&!e&&r(w,i)}catch(t){console.error("verifyOtp: fetch error",t),t instanceof TypeError&&/failed to fetch/i.test(String(t.message))?r(n,`Cannot reach backend at ${location.origin}. Is the dev server running?`):r(n,t?.message||"Network error")}finally{r(u,!1)}}function X(t){t.key==="Enter"&&(t.preventDefault(),o(J)==="guard"?H():o(V)?Q():B())}le(()=>{document.addEventListener("keydown",X);const t=document.documentElement.style.overflow||document.body.style.overflow;return document.documentElement.style.overflow="hidden",document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",X),document.documentElement.style.overflow=t,document.body.style.overflow=t}});async function Y(){if(r(J,null),!!o(v).trim())try{const t=new URL("/login/identify",location.origin);t.searchParams.set("username",o(v).trim());const x=await fetch(t.toString(),{method:"GET",credentials:"same-origin"});if(!x.ok)return;const a=await x.json().catch(()=>null);a&&a.role&&r(J,a.role)}catch(t){console.warn("identifyUser failed",t)}}me();var $=Se(),Z=m($),re=m(Z);ue(re,()=>xe,(t,x)=>{x(t,{className:"login-section",padding:"2.25rem",children:(a,i)=>{var e=ke(),l=b(G(e),2),s=b(m(l),2);{var d=c=>{var f=he(),O=m(f,!0);p(f),E(()=>F(O,o(n))),k(c,f)};I(s,c=>{o(n)&&c(d)})}var g=b(s,2);{var _=c=>{var f=be(),O=m(f,!0);p(f),E(()=>F(O,o(w))),k(c,f)};I(g,c=>{o(w)&&c(_)})}var S=b(g,2),R=b(m(S));K(R),p(S);var oe=b(S,2);{var ae=c=>{var f=we(),O=G(f),C=b(m(O));K(C),p(O);var j=b(O,2),P=m(j,!0);p(j),E(()=>{j.disabled=o(u),F(P,o(u)?"Logging in...":"Login")}),W(C,()=>o(y),h=>r(y,h)),M("click",j,H),k(c,f)},ne=c=>{var f=fe(),O=G(f);{var C=P=>{var h=_e(),U=G(h),ee=b(m(U));K(ee),p(U);var D=b(U,2),se=m(D,!0);p(D),E(()=>{D.disabled=o(u),F(se,o(u)?"Verifying...":"Verify OTP")}),W(ee,()=>o(N),ie=>r(N,ie)),M("click",D,Q),k(P,h)},j=P=>{var h=Oe(),U=m(h,!0);p(h),E(()=>{h.disabled=o(u),F(U,o(u)?"Sending...":"Send OTP")}),M("click",h,B),k(P,h)};I(O,P=>{o(V)?P(C):P(j,!1)})}k(c,f)};I(oe,c=>{o(J)==="guard"?c(ae):c(ne,!1)})}p(l),W(R,()=>o(v),c=>r(v,c)),M("blur",R,()=>Y()),k(a,e)},$$slots:{default:!0}})}),p(Z),p($),k(q,$),de()}export{Me as component};
